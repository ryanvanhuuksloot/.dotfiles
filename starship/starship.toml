# Starship Prompt Configuration

# Timeout per module (ms)
command_timeout = 500

# Prompt format — per-type colored status, graphite stack, monorepo-safe
format = """
$directory${custom.git_branch}${custom.gt_stack}${custom.git_staged}${custom.git_modified}${custom.git_untracked}${custom.git_deleted}${custom.git_conflicted}${custom.git_renamed}${custom.git_stash}${custom.git_ahead}${custom.git_behind}$git_state$cmd_duration$kubernetes
$character"""

# Directory — full path from ~
[directory]
truncate_to_repo = false
truncation_length = 0
style = "bold #b4befe"
format = "[$path]($style) "

# Git branch — disabled, replaced by custom module (libgit2 doesn't support reftable)
[git_branch]
disabled = true

# Custom git branch — works with reftable worktrees (~13ms)
[custom.git_branch]
command = "git branch --show-current 2>/dev/null"
when = "git rev-parse --is-inside-work-tree 2>/dev/null"
format = "([$output](bold #cba6f7) )"

# Built-in git status — disabled, replaced by per-type custom modules below
[git_status]
disabled = true

# Staged files — green
[custom.git_staged]
command = "s=$(timeout 0.4 git diff --cached --name-only 2>/dev/null | wc -l | tr -d ' '); [ $? -eq 124 ] && printf '+?' && exit; [ \"$s\" -gt 0 ] && printf '+%s' \"$s\""
when = true
ignore_timeout = true
format = "([$output](bold #a6e3a1) )"

# Modified files — yellow
[custom.git_modified]
command = "m=$(timeout 0.4 git diff --name-only 2>/dev/null | wc -l | tr -d ' '); [ $? -eq 124 ] && printf '~?' && exit; [ \"$m\" -gt 0 ] && printf '~%s' \"$m\""
when = true
ignore_timeout = true
format = "([$output](bold #f9e2af) )"

# Untracked files — orange
[custom.git_untracked]
command = "u=$(timeout 0.4 git ls-files --others --exclude-standard 2>/dev/null | wc -l | tr -d ' '); [ $? -eq 124 ] && printf '??' && exit; [ \"$u\" -gt 0 ] && printf '?%s' \"$u\""
when = true
ignore_timeout = true
format = "([$output](bold #fab387) )"

# Deleted files — red
[custom.git_deleted]
command = "d=$(timeout 0.4 git diff --diff-filter=D --name-only 2>/dev/null | wc -l | tr -d ' '); [ $? -eq 124 ] && printf 'x?' && exit; [ \"$d\" -gt 0 ] && printf 'x%s' \"$d\""
when = true
ignore_timeout = true
format = "([$output](bold #f38ba8) )"

# Conflicted files — red
[custom.git_conflicted]
command = "c=$(timeout 0.4 git ls-files --unmerged 2>/dev/null | cut -f2 | sort -u | wc -l | tr -d ' '); [ $? -eq 124 ] && printf '=?' && exit; [ \"$c\" -gt 0 ] && printf '=%s' \"$c\""
when = true
ignore_timeout = true
format = "([$output](bold #f38ba8) )"

# Renamed files — orange
[custom.git_renamed]
command = "r=$(timeout 0.4 git diff --cached --diff-filter=R --name-only 2>/dev/null | wc -l | tr -d ' '); [ $? -eq 124 ] && printf '»?' && exit; [ \"$r\" -gt 0 ] && printf '»%s' \"$r\""
when = true
ignore_timeout = true
format = "([$output](bold #fab387) )"

# Stashed changes — lavender
[custom.git_stash]
command = "s=$(timeout 0.4 git stash list 2>/dev/null | wc -l | tr -d ' '); [ $? -eq 124 ] && printf '*?' && exit; [ \"$s\" -gt 0 ] && printf '*%s' \"$s\""
when = true
ignore_timeout = true
format = "([$output](bold #f2cdcd) )"

# Ahead of remote (unpushed commits) — blue
[custom.git_ahead]
command = "a=$(timeout 0.4 git rev-list --count '@{upstream}..HEAD' 2>/dev/null); [ $? -eq 124 ] && printf '⇡?' && exit; [ \"$a\" -gt 0 ] && printf '⇡%s' \"$a\""
when = true
ignore_timeout = true
format = "([$output](bold #89b4fa) )"

# Behind remote (need to pull) — red
[custom.git_behind]
command = "b=$(timeout 0.4 git rev-list --count 'HEAD..@{upstream}' 2>/dev/null); [ $? -eq 124 ] && printf '⇣?' && exit; [ \"$b\" -gt 0 ] && printf '⇣%s' \"$b\""
when = true
ignore_timeout = true
format = "([$output](bold #f38ba8) )"

# Graphite stack position — reads local cache, no Node.js
[custom.gt_stack]
command = """python3 -c "
import json, os, sys
try:
    git_dir = os.popen('git rev-parse --git-dir 2>/dev/null').read().strip()
    branch = os.popen('git rev-parse --abbrev-ref HEAD 2>/dev/null').read().strip()
    cache = os.path.join(git_dir, '.graphite_cache_persist')
    if not os.path.exists(cache) or branch == 'main': sys.exit()
    with open(cache) as f: data = json.load(f)
    branches = dict(data.get('branches', []))
    if branch not in branches: sys.exit()
    info = branches[branch]
    depth, b = 0, branch
    while b in branches and branches[b].get('parentBranchName'):
        depth += 1; b = branches[b]['parentBranchName']
    children = len(info.get('children', []))
    if depth: print(f'{depth}↑{children}↓' if children else f'{depth}↑')
    elif children: print(f'{children}↓')
except: pass
" """
when = "test -f \"$(git rev-parse --git-dir 2>/dev/null)/.graphite_cache_persist\" 2>/dev/null"
format = "([$output](bold #f5c2e7) )"

# Git state (rebase, merge, etc.)
[git_state]
style = "bold #f9e2af"

# Kubernetes — no icon, at end of line
[kubernetes]
disabled = false
symbol = ""
format = '[$context](bold #74c7ec)[:$namespace](bold #585b70) '

# Command duration (show if > 2s)
[cmd_duration]
min_time = 2_000
format = "[took $duration](bold #f9e2af) "

# Prompt character
[character]
success_symbol = "[>](bold #a6e3a1)"
error_symbol = "[>](bold #f38ba8)"
